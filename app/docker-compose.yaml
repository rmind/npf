version: '3.4'

services:

  npf:
    build:
      context: ..
      dockerfile: app/conf/npf.Dockerfile
    image: npf

  npf-router-dev:
    build:
      context: ..
      dockerfile: app/conf/npf-router.Dockerfile
      target: npf-dpdk-builder
    image: npf_router_dev
    privileged: true
    depends_on:
      - npf
    hostname: npf-router-dev
    networks:
      default:
      testnet:
        ipv4_address: 10.0.0.2
    volumes:
      - ../:/src

  npf-router:
    build:
      context: ..
      dockerfile: app/conf/npf-router.Dockerfile
    image: npf_router
    privileged: true
    depends_on:
      - npf
    hostname: npf-router
    networks:
      default:
      testnet:
        ipv4_address: 10.0.0.2
    command:
      - "/app/run.sh"

  host-1:
    build:
      context: ..
      dockerfile: app/conf/host.Dockerfile
    image: npf_host_1
    privileged: true
    hostname: npf_host_1
    networks:
      testnet:
        ipv4_address: 10.0.0.3
    #depends_on:
    #  - npf-router
    command:
      - "sh"
      - "-c"
      - "ping -i 60 -W 30 10.0.0.2"

networks:
  testnet:
    #
    # NOTE: Must the 'macvlan' driver, otherwise Docker interferes
    # at the Ethernet layer.
    #
    driver: macvlan
    internal: true
    ipam:
      config:
        - subnet: 10.0.0.0/24
